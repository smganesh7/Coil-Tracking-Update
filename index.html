<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coil Tracking Update</title>
    <style>
        table, th, td {
            border: 1px solid black;
            border-collapse: collapse;
            padding: 8px;
        }
        th, td {
            text-align: center;
        }
    </style>
    <!-- Include SheetJS for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <!-- Include jsPDF for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
    <!-- Include jsPDF AutoTable for table formatting in PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
    <h1>Coil Tracking Update</h1>
    
    <form id="inventoryForm">
        <label for="product">Coil Number:</label>
        <input type="text" id="product" name="product" required><br><br>

        <label for="bay">Bay:</label>
        <select id="bay" name="bay">
            <option value="MN">MN</option>
            <option value="NP">NP</option>
            <option value="PQ">PQ</option>
            <option value="RS">RS</option>
            <option value="ST">ST</option>
        </select><br><br>
        
        <label for="column">Column:</label>
        <input type="text" id="column" name="column" maxlength="1" placeholder="A-Z" required><br><br>
        
        <label for="row">Row:</label>
        <input type="number" id="row" name="row" min="1" max="26" required><br><br>
        
        <button type="button" onclick="updateInventory()">Update Inventory</button>
    </form>
    
    <h2>Inventory Status</h2>
    <button type="button" onclick="downloadAsExcel()">Download as Excel</button>
    <button type="button" onclick="downloadAsPDF()">Download as PDF</button>
    <input type="checkbox" id="selectAll" onclick="toggleSelectAll()"> Select/Deselect All
    <div id="inventoryTable">
        <!-- Inventory table will be inserted here by JavaScript -->
    </div>
    
    <script>
        let inventory = {
            MN: { A: { 1: "", 2: "", 3: "" }, B: { 1: "", 2: "", 3: "" }, C: { 1: "", 2: "", 3: "" } },
            NP: { A: { 1: "", 2: "", 3: "" }, B: { 1: "", 2: "", 3: "" }, C: { 1: "", 2: "", 3: "" } },
            PQ: { A: { 1: "", 2: "", 3: "" }, B: { 1: "", 2: "", 3: "" }, C: { 1: "", 2: "", 3: "" } },
            RS: { A: { 1: "", 2: "", 3: "" }, B: { 1: "", 2: "", 3: "" }, C: { 1: "", 2: "", 3: "" } },
            ST: { A: { 1: "", 2: "", 3: "" }, B: { 1: "", 2: "", 3: "" }, C: { 1: "", 2: "", 3: "" } }
        };

        // Function to update inventory
        function updateInventory() {
            const bay = document.getElementById('bay').value;
            const column = document.getElementById('column').value.toUpperCase();
            const row = document.getElementById('row').value;
            const product = document.getElementById('product').value;

            if (!inventory[bay] || !inventory[bay][column] || inventory[bay][column][row] === undefined) {
                alert("Invalid Column or Row!");
                return;
            }

            // Check for duplicate coil number at a different location
            let duplicateLocation = null;
            for (let b in inventory) {
                for (let c in inventory[b]) {
                    for (let r in inventory[b][c]) {
                        if (inventory[b][c][r] === product && !(b === bay && c === column && r === row)) {
                            duplicateLocation = `${b}-${c}-${r}`;
                            break;
                        }
                    }
                    if (duplicateLocation) break;
                }
                if (duplicateLocation) break;
            }

            if (duplicateLocation) {
                let [dupBay, dupColumn, dupRow] = duplicateLocation.split('-');
                if (!confirm(`Coil number ${product} is already in ${dupBay}-${dupColumn}-${dupRow}. Do you want to replace it with ${product} at ${bay}-${column}-${row}?`)) {
                    return;
                }
                // Clear the old location
                inventory[dupBay][dupColumn][dupRow] = "";
            }

            // Update the inventory
            inventory[bay][column][row] = product;
            displayInventory();
        }

        // Function to display inventory
        function displayInventory() {
            let tableHTML = '<table><tr><th>Coil Number</th><th>Bay</th><th>Column</th><th>Row</th></tr>';

            for (let bay in inventory) {
                for (let column in inventory[bay]) {
                    for (let row in inventory[bay][column]) {
                        if (inventory[bay][column][row] !== "") {
                            tableHTML += `<tr>
                                            <td>${inventory[bay][column][row]}</td>
                                            <td>${bay}</td>
                                            <td>${column}</td>
                                            <td>${row}</td>
                                          </tr>`;
                        }
                    }
                }
            }

            tableHTML += '</table>';
            document.getElementById('inventoryTable').innerHTML = tableHTML;
        }

        // Function to download inventory as Excel
        function downloadAsExcel() {
            let wb = XLSX.utils.book_new();
            let ws_data = 'Coil Tracking Update'], [''], ['Coil Number', 'Bay', 'Column', 'Row';

            for (let bay in inventory) {
                for (let column in inventory[bay]) {
                    for (let row in inventory[bay][column]) {
                        if (inventory[bay][column][row] !== "") {
                            ws_data.push([inventory[bay][column][row], bay, column, row]);
                        }
                    }
                }
            }

            let ws = XLSX.utils.aoa_to_sheet(ws_data);
            XLSX.utils.book_append_sheet(wb, ws, "Inventory");
            XLSX.writeFile(wb, "Inventory.xlsx");
        }

        // Function to download inventory as PDF
        function downloadAsPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ format: 'a4' });

            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.text("Coil Tracking Update", doc.internal.pageSize.getWidth() / 2, 20, { align: 'center' });
            
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');

            let columns = ["Coil Number", "Bay", "Column", "Row"];
            let tableData = [];

            // Collect data for the table
            for (let bay in inventory) {
                for (let column in inventory[bay]) {
                    for (let row in inventory[bay][column]) {
                        if (inventory[bay][column][row] !== "") {
                            tableData.push([inventory[bay][column][row], bay, column, row]);
                        }
                    }
                }
            }

            doc.autoTable({
                head: [columns],
                body: tableData,
                startY: 30,
                styles: { 
                    cellPadding: 3, 
                    fontSize: 10, 
                    halign: 'center', 
                    valign: 'middle', 
                    lineWidth: 0.5,
                    lineColor: [0, 0, 0] 
                },
                tableLineColor: [0, 0, 0],
                tableLineWidth: 0.5
            });

            doc.save("Inventory.pdf");
        }

        // Function to toggle select/deselect all
        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('.delete-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
        }

        // Initialize and display the inventory on page load
        displayInventory();
    </script>
</body>
</html>
